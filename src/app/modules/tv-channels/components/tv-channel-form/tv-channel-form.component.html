<div class="channel-form-container">
  <!-- Duplication Alert Banner -->
  <div
    *ngIf="isDuplicateMode"
    class="alert alert-info mb-4"
    style="border-left: 4px solid #3b82f6"
  >
    <div class="d-flex align-items-center">
      <i class="fas fa-copy me-3" style="font-size: 1.2em; color: #3b82f6"></i>
      <div>
        <strong>Duplicating Channel:</strong>
        <span
          >You are creating a copy of an existing channel. Please review and
          modify the details below before saving.</span
        >
      </div>
    </div>
  </div>

  <div class="page-header">
    <div class="page-header-content">
      <h1 class="page-title">
        <i class="fas {{ pageIcon }} me-2"></i>
        {{ pageTitle }}
      </h1>
    </div>

    <!-- Add breadcrumb for better navigation -->
    <div class="page-actions">
      <nav aria-label="breadcrumb" *ngIf="isDuplicateMode || isEditMode">
        <ul class="breadcrumb mb-0">
          <li class="breadcrumb-item">
            <a [routerLink]="['/channels']" class="text-decoration-none">
              <i class="fas fa-tv me-1"></i>
              Channels
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            <span *ngIf="isEditMode && !isDuplicateMode">Edit Channel</span>
            <span *ngIf="isDuplicateMode"> Duplicate Channel</span>
            <span *ngIf="!isEditMode && !isDuplicateMode"> Add Channel</span>
          </li>
        </ul>
      </nav>

      <button
        class="btn btn-secondary"
        (click)="onCancel()"
        [disabled]="submitting"
      >
        <i class="fas fa-arrow-left"></i>
        Back to List
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>
        {{
          isDuplicateMode
            ? "Loading channel for duplication..."
            : "Loading channel data..."
        }}
      </p>
    </div>
  </div>

  <div class="form-container" *ngIf="!loading">
    <form [formGroup]="channelForm" (ngSubmit)="onSubmit()">
      <!-- Basic Information Section -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fas fa-tv"></i>
          Basic Information
          <small *ngIf="isDuplicateMode" class="text-muted ms-2"
            >(Modified for new channel)</small
          >
        </h3>

        <div class="form-row-tv">
          <div class="form-group">
            <label for="channelNumber" class="required">Channel Number</label>
            <input
              type="number"
              id="channelNumber"
              formControlName="channelNumber"
              class="form-control"
              [class.error]="isFieldInvalid('channelNumber')"
              [class.modified]="isDuplicateMode"
              placeholder="e.g., 101"
              min="1"
              max="9999"
            />
            <div class="input-help">
              <small>
                {{
                  isDuplicateMode
                    ? "Suggested new channel number (please verify)"
                    : "Unique number for this channel (1-9999)"
                }}
              </small>
            </div>
            <div *ngIf="isFieldInvalid('channelNumber')" class="error-message">
              {{ getFieldError("channelNumber") }}
            </div>
          </div>

          <div class="form-group">
            <label for="sortOrder" class="required">Sort order</label>
            <input
              type="number"
              id="sortOrder"
              formControlName="sortOrder"
              class="form-control"
              [class.error]="isFieldInvalid('sortOrder')"
              [class.modified]="isDuplicateMode"
              placeholder="e.g., 101"
              min="1"
              max="9999"
            />
            <div class="input-help">
              <small>
                {{
                  isDuplicateMode
                    ? "Suggested new sort order (please verify)"
                    : "Unique sort order for this channel (1-9999)"
                }}
              </small>
            </div>
            <div *ngIf="isFieldInvalid('sortOrder')" class="error-message">
              {{ getFieldError("sortOrder") }}
            </div>
          </div>

          <div class="form-group">
            <label for="name" class="required">Channel Name</label>
            <input
              type="text"
              id="name"
              formControlName="name"
              class="form-control"
              [class.error]="isFieldInvalid('name')"
              [class.modified]="isDuplicateMode"
              placeholder="e.g., CNN International"
              maxlength="100"
            />
            <div class="input-help">
              <small>
                {{
                  isDuplicateMode
                    ? 'Modified name with "(Copy)" suffix'
                    : "Display name for the channel (2-100 characters)"
                }}
              </small>
            </div>
            <div *ngIf="isFieldInvalid('name')" class="error-message">
              {{ getFieldError("name") }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="categoryId" class="required">Category</label>
            <select
              id="categoryId"
              formControlName="categoryId"
              class="form-control"
              [class.error]="isFieldInvalid('categoryId')"
            >
              <option value="">Select Category</option>
              <option *ngFor="let category of categories" [value]="category.id">
                {{ category.name }}
              </option>
            </select>
            <div class="input-help">
              <small>{{
                isDuplicateMode
                  ? "Inherited from original channel"
                  : "Channel category for organization"
              }}</small>
            </div>
            <div *ngIf="isFieldInvalid('categoryId')" class="error-message">
              {{ getFieldError("categoryId") }}
            </div>
          </div>

          <div class="form-group">
            <label for="languageId" class="required">Language</label>
            <select
              id="languageId"
              formControlName="languageId"
              class="form-control"
              [class.error]="isFieldInvalid('languageId')"
            >
              <option value="">Select Language</option>
              <option *ngFor="let language of languages" [value]="language.id">
                {{ language.name }} ({{ language.iso6392 }})
              </option>
            </select>
            <div class="input-help">
              <small>{{
                isDuplicateMode
                  ? "Inherited from original channel"
                  : "Primary language of the channel"
              }}</small>
            </div>
            <div *ngIf="isFieldInvalid('languageId')" class="error-message">
              {{ getFieldError("languageId") }}
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea
            id="description"
            formControlName="description"
            class="form-control"
            [class.error]="isFieldInvalid('description')"
            rows="3"
            placeholder="Brief description of the channel content..."
            maxlength="500"
          ></textarea>
          <div class="input-help">
            <small>{{
              isDuplicateMode
                ? "Inherited description (you can modify it)"
                : "Optional description (max 500 characters)"
            }}</small>
          </div>
          <div *ngIf="isFieldInvalid('description')" class="error-message">
            {{ getFieldError("description") }}
          </div>
        </div>
      </div>

      <!-- Network Configuration Section -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fas fa-network-wired"></i>
          Network Configuration
          <small *ngIf="isDuplicateMode" class="text-muted ms-2"
            >(Port automatically incremented)</small
          >
        </h3>

        <div class="form-row">
          <div class="form-group">
            <label for="ip" class="required">IP Address</label>
            <input
              type="text"
              id="ip"
              formControlName="ip"
              class="form-control"
              [class.error]="isFieldInvalid('ip')"
              [class.success]="connectionTestResult?.success"
              placeholder="192.168.1.100"
              pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
            />
            <div class="input-help">
              <small>{{
                isDuplicateMode
                  ? "Inherited IP address (verify if correct)"
                  : "Stream server IP address (IPv4 format)"
              }}</small>
            </div>
            <div *ngIf="isFieldInvalid('ip')" class="error-message">
              {{ getFieldError("ip") }}
            </div>
          </div>

          <div class="form-group">
            <label for="port" class="required">Port</label>
            <input
              type="number"
              id="port"
              formControlName="port"
              class="form-control"
              [class.error]="isFieldInvalid('port')"
              [class.success]="connectionTestResult?.success"
              [class.modified]="isDuplicateMode"
              placeholder="8001"
              min="1"
              max="65535"
            />
            <div class="input-help">
              <small>
                {{
                  isDuplicateMode
                    ? "Port incremented by +1 from original"
                    : "Stream server port (1-65535)"
                }}
              </small>
            </div>
            <div *ngIf="isFieldInvalid('port')" class="error-message">
              {{ getFieldError("port") }}
            </div>
          </div>
        </div>

        <!-- Stream URL -->
        <div class="form-row">
          <div class="form-group">
            <label for="streamUrl" class="required">Stream URL</label>
            <input
              type="text"
              id="streamUrl"
              formControlName="streamUrl"
              class="form-control"
              [class.error]="isFieldInvalid('streamUrl')"
              placeholder="udp://@239.1.1.101:1234"
            />
            <div class="input-help">
              <small>{{
                isDuplicateMode
                  ? "Inherited stream URL (update if needed)"
                  : "Complete stream URL or backup stream configuration"
              }}</small>
            </div>
            <div *ngIf="isFieldInvalid('streamUrl')" class="error-message">
              {{ getFieldError("streamUrl") }}
            </div>
          </div>
        </div>
      </div>

      <!-- Logo and Branding Section -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fas fa-image"></i>
          Logo and Branding
          <small *ngIf="isDuplicateMode" class="text-muted ms-2"
            >(Logo inherited, but you can change it)</small
          >
        </h3>

        <div class="logo-section">
          <!-- Logo Upload Options -->
          <div class="logo-upload-tabs">
            <button
              type="button"
              class="tab-button"
              [class.active]="logoUploadMode === 'file'"
              (click)="setLogoUploadMode('file')"
            >
              <i class="fas fa-upload"></i> Upload File
            </button>
            <button
              type="button"
              class="tab-button"
              [class.active]="logoUploadMode === 'url'"
              (click)="setLogoUploadMode('url')"
            >
              <i class="fas fa-link"></i> Use URL
            </button>
          </div>

          <!-- File Upload Option -->
          <div *ngIf="logoUploadMode === 'file'" class="logo-upload-section">
            <div class="form-group">
              <label for="logoFile">Logo File</label>
              <div class="file-upload-wrapper">
                <input
                  type="file"
                  id="logoFile"
                  accept="image/*"
                  (change)="onFileSelected($event)"
                  class="file-input"
                  #fileInput
                />
                <label for="logoFile" class="file-upload-label">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span *ngIf="!logoFile">Choose a logo file</span>
                  <span *ngIf="logoFile">{{ logoFile.name }}</span>
                </label>
                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  *ngIf="logoFile"
                  (click)="clearLogoFile()"
                >
                  <i class="fas fa-times"></i> Clear
                </button>
              </div>
              <div class="input-help">
                <small>Accepted formats: JPG, PNG, GIF, WebP (Max 5MB)</small>
              </div>
              <div *ngIf="logoFileError" class="error-message">
                {{ logoFileError }}
              </div>
            </div>
          </div>

          <!-- URL Option -->
          <div *ngIf="logoUploadMode === 'url'" class="logo-upload-section">
            <div class="form-group">
              <label for="logoUrl">Logo URL</label>
              <div class="logo-input-group">
                <input
                  type="url"
                  id="logoUrl"
                  formControlName="logoUrl"
                  class="form-control"
                  [class.error]="isFieldInvalid('logoUrl')"
                  placeholder="https://example.com/logo.png"
                />
                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  (click)="onClearLogo()"
                  *ngIf="logoUrl?.value"
                  title="Clear logo URL"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="input-help">
                <small>{{
                  isDuplicateMode
                    ? "Logo URL inherited from original channel"
                    : "Optional logo image URL (PNG, JPG, SVG supported)"
                }}</small>
              </div>
              <div *ngIf="isFieldInvalid('logoUrl')" class="error-message">
                {{ getFieldError("logoUrl") }}
              </div>
            </div>
          </div>

          <!-- Logo Preview -->
          <div class="logo-preview" *ngIf="logoPreviewUrl || existingLogoUrl">
            <div class="preview-label">Preview:</div>
            <div class="preview-container">
              <img
                *ngIf="logoPreviewUrl || existingLogoUrl"
                [src]="logoPreviewUrl || existingLogoUrl"
                [alt]="name?.value || 'Channel logo'"
                class="logo-image"
                (error)="onLogoPreviewError()"
              />
              <div
                *ngIf="!logoPreviewUrl && !existingLogoUrl"
                class="preview-placeholder"
              >
                <i class="fas fa-image"></i>
                <span>No logo</span>
              </div>
            </div>
            <div *ngIf="isDuplicateMode && logoPreviewUrl" class="preview-info">
              <small
                ><i class="fas fa-info-circle"></i> Logo inherited from original
                channel</small
              >
            </div>
            <div
              *ngIf="
                existingLogoUrl &&
                !logoFile &&
                !logoUrl?.value &&
                !isDuplicateMode
              "
              class="preview-info"
            >
              <small
                ><i class="fas fa-info-circle"></i> Current logo from
                server</small
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div
        class="form-actions d-flex justify-content-between align-items-center mt-4 pt-4 border-top"
      >
        <div class="form-info text-muted small" *ngIf="isDuplicateMode">
          <i class="fas fa-info-circle me-1"></i>
          Creating a new channel based on existing channel data
        </div>

        <div class="action-buttons ms-auto">
          <button
            type="button"
            class="btn btn-secondary me-3"
            (click)="onCancel()"
            [disabled]="submitting"
          >
            <i class="fas fa-times me-2"></i>
            Cancel
          </button>

          <button
            type="button"
            class="btn btn-info me-3"
            (click)="onTestConnection()"
            [disabled]="
              submitting ||
              testingConnection ||
              channelForm.get('ip')?.invalid ||
              channelForm.get('port')?.invalid
            "
          >
            <i
              class="fas fa-satellite-dish me-2"
              [class.fa-spin]="testingConnection"
            ></i>
            {{ testingConnection ? "Testing..." : "Test Connection" }}
          </button>

          <button
            type="submit"
            class="btn btn-lg"
            [class.btn-primary]="!isDuplicateMode"
            [class.btn-info]="isDuplicateMode"
            [disabled]="
              channelForm.invalid ||
              submitting ||
              testingConnection ||
              !!logoFileError
            "
          >
            <!-- Loading spinner when submitting -->
            <i *ngIf="submitting" class="fas fa-spinner fa-spin me-2"></i>

            <!-- Icon based on mode when not submitting -->
            <i
              *ngIf="!submitting"
              class="fas me-2"
              [class.fa-copy]="isDuplicateMode"
              [class.fa-save]="isEditMode && !isDuplicateMode"
              [class.fa-plus]="!isEditMode && !isDuplicateMode"
            ></i>

            {{ submitButtonText }}
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Form Summary (for review before submit) -->
  <div class="form-summary" *ngIf="!loading && channelForm.valid">
    <h4>
      Channel Summary
      <span *ngIf="isDuplicateMode" class="badge bg-info ms-2">Duplicate</span>
    </h4>
    <div class="summary-content">
      <div class="summary-row">
        <span class="label">Channel:</span>
        <span class="value"
          >{{ channelNumber?.value }} - {{ name?.value }}</span
        >
      </div>
      <div class="summary-row" *ngIf="categoryId?.value">
        <span class="label">Category:</span>
        <span class="value">{{ getCategoryName(categoryId?.value) }}</span>
      </div>
      <div class="summary-row" *ngIf="languageId?.value">
        <span class="label">Language:</span>
        <span class="value">{{ getLanguageName(languageId?.value) }}</span>
      </div>
      <div class="summary-row">
        <span class="label">Stream:</span>
        <span class="value">{{ ip?.value }}:{{ port?.value }}</span>
      </div>
      <div class="summary-row" *ngIf="logoFile || logoUrl?.value">
        <span class="label">Logo:</span>
        <span class="value">
          <i class="fas fa-check text-success"></i>
          {{ logoFile ? "File selected" : "URL provided" }}
        </span>
      </div>
      <div class="summary-row" *ngIf="connectionTestResult">
        <span class="label">Connection:</span>
        <span
          class="value status"
          [class.success]="connectionTestResult.success"
          [class.error]="!connectionTestResult.success"
        >
          <i
            class="fas"
            [class.fa-check]="connectionTestResult.success"
            [class.fa-times]="!connectionTestResult.success"
          ></i>
          {{ connectionTestResult.success ? "Available" : "Failed" }}
        </span>
      </div>
    </div>
  </div>
</div>
